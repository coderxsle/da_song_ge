# 远程服务器管理与自动化部署脚本

## 需求规格说明书（PRD / 技术需求版）

---

## 1. 项目背景与目标

### 1.1 背景
在日常开发、部署与运维过程中，常常需要：
- 向多台远程服务器上传文件（前端静态资源、后端 JAR 包、配置文件等）
- 在远程服务器上执行命令（启动脚本、重启服务等）
- 管理多个项目的多台服务器连接方式与凭证
- 支持不同的上传模式（同步/复制）和文件清理策略

### 1.2 目标
本项目旨在开发一个本地运行的 Python 脚本工具，用于统一管理多台远程服务器，并支持：
- 批量文件上传（支持 sync/copy 两种模式）
- 远程命令执行
- 灵活的认证方式配置（SSH 密钥）
- 分类上传管理（frontend_admin、frontend_static、backend_api_server 等）
- 提升部署效率并减少人为错误

---

## 2. 使用场景

### 2.1 典型场景
- **前端部署**：本地构建完成后（如 Vue/React 项目的 dist 目录），将静态资源上传到多台服务器的指定目录
- **后端部署**：将 Spring Boot 打包的 JAR 文件和启动脚本上传到服务器，并执行启动命令
- **多项目管理**：管理多个项目（如"领航不良资产"、"汽车园区项目"）的服务器配置
- **一键部署**：选择指定服务器和上传类型，一键完成上传和命令执行

### 2.2 使用角色
- 开发人员
- 运维人员
- 技术负责人（个人或小团队）

---

## 3. 系统总体说明

### 3.1 运行环境
- **本地环境**：Mac / Linux / Windows
- **Python 版本**：Python 3.12+
- **依赖库**：paramiko（SSH 连接）、PyYAML（配置解析）

### 3.2 工具形态
- 命令行脚本工具（CLI）
- 不依赖 GUI
- 支持交互式选择和命令行参数

### 3.3 网络要求
- 可访问目标服务器的 SSH 端口
- 支持 SSH 密钥认证

---

## 4. 功能需求

### 4.1 服务器管理

#### 4.1.1 支持多服务器配置
- 用户可以配置**多个远程服务器**
- 每台服务器配置互相独立
- 服务器以**唯一名称**（name）区分，如"领航不良资产"、"汽车园区项目"

#### 4.1.2 服务器基础信息配置
每个服务器需支持以下字段：

| 字段 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| name | string | 是 | 服务器名称（唯一标识） | "领航不良资产" |
| host | string | 是 | 服务器 IP 地址 | "192.168.1.10" |
| port | int | 是 | SSH 端口 | 5555 |
| username | string | 是 | SSH 用户名 | "deploy" |
| auth | object | 是 | 认证配置 | 见下文 |
| upload | object | 否 | 上传任务配置 | 见下文 |
| commands | object | 否 | 远程命令配置 | 见下文 |

---

### 4.2 远程连接方式

#### 4.2.1 支持的认证方式
- **SSH 公钥认证**（推荐，优先级最高）
- 用户名 + 密码认证（可选，暂不实现）

#### 4.2.2 认证方式配置
```yaml
auth:
  type: ssh_key          # 认证类型：ssh_key 或 password
  key_path: ~/.ssh/id_rsa  # SSH 私钥路径（支持 ~ 展开）
```

#### 4.2.3 认证优先级规则
- 优先使用 SSH 密钥认证
- 若密钥认证失败，输出错误日志并终止连接

---

### 4.3 文件上传功能

#### 4.3.1 上传方式
- 使用 **SFTP**（基于 paramiko）
- 支持**单文件**和**目录**上传
- 支持两种上传模式：
  - **sync**：同步模式，服务器目录完全同步本地目录（可选删除多余文件）
  - **copy**：复制模式，仅上传本地文件，不删除服务器上的其他文件

#### 4.3.2 文件上传配置
每个服务器可配置多种上传任务类型（可自定义），常见类型包括：
- `frontend_admin`：前端后台管理页面
- `frontend_static`：前端静态页面
- `backend_api_server`：后端接口服务

每个上传任务支持以下字段：

| 字段 | 类型 | 必填 | 说明 | 示例 |
|------|------|------|------|------|
| local_path | string | 是 | 本地文件/目录路径（支持 ~ 展开） | "~/workspace/project/dist-prod/" |
| remote_path | string | 是 | 远程目标路径 | "/home/admin/web_projects/server-backui/" |
| mode | string | 否 | 上传模式：sync 或 copy（默认 copy） | "sync" |
| delete_extra | bool | 否 | 是否删除服务器上多余的文件（仅 sync 模式有效） | true |

**配置示例**：
```yaml
upload:
  frontend_admin:
    - local_path: ~/workspace/ling_hang/ling_hang_admin/dist-prod/
      remote_path: /home/admin/web_projects/dccw/server-backui/
      mode: sync
      delete_extra: true
  
  backend_api_server:
    - local_path: ~/workspace/ling_hang/ling_hang_server/yudao-server/target/yudao-server.jar
      remote_path: /home/admin/web_projects/dccw/server-api/
    
    - local_path: ~/workspace/ling_hang/ling_hang_server/script/shell/startup1.sh
      remote_path: /home/admin/web_projects/dccw/server-api/bin
```

#### 4.3.3 上传行为说明
- **上传前检查**：检测本地文件/目录是否存在，不存在则报错并跳过
- **自动创建目录**：若远程目录不存在，自动创建（包括父目录）
- **上传进度**：显示上传进度（文件名、大小、进度百分比）
- **上传结果**：输出成功/失败日志，包含文件路径和错误信息
- **sync 模式**：
  - 递归比对本地和远程目录
  - 上传本地新增或修改的文件
  - 若 `delete_extra: true`，删除服务器上多余的文件
- **copy 模式**：
  - 仅上传本地文件，不删除服务器文件

---

### 4.4 远程命令执行

#### 4.4.1 命令配置
每个服务器可配置一组需要执行的命令：
- 支持多条命令
- 按配置顺序执行
- 前一条失败是否继续执行可配置（默认失败即停止）

#### 4.4.2 命令执行配置字段
```yaml
commands:
  backend_api_server:
    - cd /home/admin/web_projects/dccw/server-api/bin
    - sh startup1.sh
```

**说明**：
- `commands` 是一个字典，key 为命令组名称（如 `backend_api_server`）
- 每个命令组包含一个命令列表
- 命令按顺序执行，前一条失败则停止后续命令

#### 4.4.3 命令执行结果
- **实时输出**：捕获标准输出与错误输出，实时显示
- **执行状态**：输出每条命令的执行状态码（0 表示成功）
- **日志标识**：日志需清晰标识服务器名称、命令组名称与命令内容
- **错误处理**：若命令执行失败（状态码非 0），输出错误信息并终止后续命令

---

### 4.5 执行流程控制

#### 4.5.1 单服务器执行
- 用户可指定某一台服务器（通过服务器名称）
- 执行该服务器的全部上传任务和命令

#### 4.5.2 多服务器批量执行（暂不实现）
- 支持选择多个服务器（暂不实现）
- 支持**顺序执行**（默认）或**并行执行**（暂不实现）

#### 4.5.3 执行顺序（默认）
1. **解析配置文件**：读取 `config.yaml`，验证配置合法性
2. **选择服务器**：交互式选择或通过命令行参数指定
3. **选择上传类型**：选择要执行的上传任务类型（如 `frontend_admin`、`backend_api_server`）
4. **建立 SSH 连接**：使用 SSH 密钥认证连接服务器
5. **上传文件**：按配置上传文件（支持 sync/copy 模式）
6. **执行远程命令**：按配置执行命令组
7. **关闭连接**：断开 SSH 连接
8. **输出总结**：显示执行结果摘要（成功/失败的任务数）

---

## 5. 配置管理

### 5.1 配置文件形式
- 使用 **YAML** 格式
- 所有服务器配置集中管理在 `config.yaml`
- 支持注释和多行配置

### 5.2 配置文件结构
```yaml
servers:
  - name: 服务器名称
    host: IP地址
    port: SSH端口
    username: 用户名
    auth:
      type: ssh_key
      key_path: 密钥路径
    upload:
      上传类型1:
        - local_path: 本地路径
          remote_path: 远程路径
          mode: sync/copy
          delete_extra: true/false
      上传类型2:
        - ...
    commands:
      命令组1:
        - 命令1
        - 命令2
      命令组2:
        - ...
```

### 5.3 配置文件示例
请参考 `scripts/config.yaml`

---

## 6. 日志与错误处理

### 6.1 日志级别
- **INFO**：正常流程信息（绿色）
- **WARN**：警告信息（黄色）
- **ERROR**：错误信息（红色）

### 6.2 日志格式
```
[INFO] 消息内容
[WARN] 警告内容
[ERROR] 错误内容
```

### 6.3 日志内容
- **连接日志**：显示连接服务器的信息（服务器名称、IP、端口）
- **上传日志**：显示上传文件的路径、大小、进度
- **命令日志**：显示执行的命令和输出结果
- **错误日志**：显示错误类型、错误信息、堆栈跟踪（可选）

### 6.4 错误处理
- **配置错误**：配置文件格式错误、必填字段缺失等，输出错误信息并退出
- **连接错误**：SSH 连接失败、认证失败等，输出错误信息并跳过该服务器
- **上传错误**：本地文件不存在、远程目录无权限等，输出错误信息并跳过该任务
- **命令错误**：命令执行失败（状态码非 0），输出错误信息并终止后续命令

---

## 7. 命令行接口（CLI）

### 7.1 基本用法
```bash
python remote_deploy.py [选项]
```

### 7.2 命令行参数
| 参数 | 简写 | 说明 | 示例 |
|------|------|------|------|
| --config | -c | 指定配置文件路径 | -c config.yaml |
| --server | -s | 指定服务器名称 | -s "领航不良资产" |
| --upload-type | -u | 指定上传类型 | -u frontend_admin |
| --command-group | -g | 指定命令组 | -g backend_api_server |
| --dry-run | -d | 模拟执行（不实际上传和执行命令） | -d |
| --help | -h | 显示帮助信息 | -h |

### 7.3 交互式模式
若不指定参数，脚本将进入交互式模式：
1. 显示所有服务器列表，用户选择服务器
2. 显示该服务器的上传类型列表，用户选择上传类型
3. 显示该服务器的命令组列表，用户选择命令组
4. 确认执行，开始部署

---

## 8. 代码风格与规范

### 8.1 代码风格
参考 `deploy_tool/scripts/deploy.py` 的代码风格：
- 使用 **类** 封装功能（如 `DeployService`）
- 使用 **静态方法** 作为入口（如 `@staticmethod def deploy()`）
- 使用 **私有方法**（`_method_name`）拆分功能模块
- 使用 **类型注解**（Type Hints）
- 使用 **文档字符串**（Docstring）

### 8.2 命名规范
- **类名**：大驼峰命名法（如 `DeployService`）
- **方法名**：小写下划线命名法（如 `_upload_all_files`）
- **变量名**：小写下划线命名法（如 `deploy_path`）
- **常量名**：大写下划线命名法（如 `SCRIPT_DIR`）

### 8.3 日志工具
使用统一的日志工具函数：
```python
from common.log_utils import log_info, log_warn, log_error

log_info("正常信息")
log_warn("警告信息")
log_error("错误信息")
```

### 8.4 错误处理
- 使用 **返回值**（bool）表示成功/失败
- 关键步骤失败时，输出错误日志并返回 `False`
- 在主流程中检查返回值，失败时终止后续步骤

---

## 9. 技术实现要点

### 9.1 SSH 连接
- 使用 `paramiko` 库
- 支持 SSH 密钥认证
- 连接失败时自动重试（可选）

### 9.2 文件上传
- 使用 `paramiko.SFTPClient`
- 支持递归上传目录
- 支持断点续传（可选）
- 显示上传进度

### 9.3 命令执行
- 使用 `SSHClient.exec_command()`
- 实时捕获标准输出和错误输出
- 获取命令执行状态码

### 9.4 配置解析
- 使用 `PyYAML` 解析 YAML 配置文件
- 验证配置字段的合法性
- 支持路径展开（`~` 展开为用户主目录）

---

## 10. 非功能性需求

### 10.1 性能要求
- 单个文件上传速度不低于 1MB/s（取决于网络环境）
- 支持并发上传多个文件（可选）

### 10.2 安全要求
- SSH 密钥文件权限检查（建议 600）
- 不在日志中输出敏感信息（如密码、密钥内容）

### 10.3 可维护性
- 代码结构清晰，模块化设计
- 关键功能有单元测试（可选）
- 配置文件有详细注释

---

## 11. 后续扩展（可选）

### 11.1 功能扩展
- 支持密码认证
- 支持并行执行多台服务器
- 支持断点续传
- 支持文件备份（上传前备份服务器文件）
- 支持回滚功能（部署失败时自动回滚）

### 11.2 界面扩展
- 提供 Web 界面（可选）
- 提供桌面 GUI（可选）

---

## 12. 参考资料

- 配置文件示例：`scripts/config.yaml`
- 代码风格参考：`deploy_tool/scripts/deploy.py`
- SSH 连接工具：`common/ssh_client.py`（假设存在）
